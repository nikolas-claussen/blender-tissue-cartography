# blender-tissue-cartography


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->

## Work in progress!

- Tools for individual recordings are in a reasonably complete state.
- Python mesh operations (remeshing, smoothing, etc) can be carried out
  in `pymeshlab` or `open3d`. User-friendly interfaces for both are
  provided. Core functionality is independent of both `pymeshlab` or
  `open3d`.
- Support for multiple recordings (e.g. frames of a movie with a dynamic
  surface or multiple images of similarly-shaped structures) is in
  progress
  - Done: automated affine registration + manual “shrink-wrapping” in
    blender to align surfaces from multiple recordings and get
    consistent cartographic projections
  - Done: automated shrink-wrapping using `open3d` and `pymeshlab`.
  - To do: example of pipeline for a whole movie.

## Installation

1.  Install required non-python programs: [Fiji](https://fiji.sc/)
    (optional), [Ilastik](https://www.ilastik.org/),
    [Meshlab](https://www.meshlab.net/) (optional), and
    [Blender](https://www.blender.org/).

2.  Install python via
    [anaconda/miniconda](https://docs.anaconda.com/miniconda/miniconda-install/),
    if you haven’t already.

    - If `conda` is unbearably slow for you, install
      [mamba](https://mamba.readthedocs.io/en/latest/index.html), a
      `conda` replacement which is much faster.

3.  [Clone this github
    repository](https://docs.github.com/en/repositories/creating-and-managing-repositories/cloning-a-repository).

4.  Create a `conda` environment with all python dependencies and
    install the `blender_tissue_cartography` module. Open a command
    window in the `blender-tissue-cartography` directory and type:

    - `conda env create -n blender_tissue_cartography -f environment.yml`
    - `conda activate blender_tissue_cartography`
    - `pip install -e .`

5.  (Optional) Install extra python libraries for `pymeshlab` and
    `open3d` which are required for some advanced functionality
    (remeshing and smoothing from within python, dynamic surfaces).

    - `pip install pymeshlab` - Note that this package is not available
      on new ARM Apple computers.
    - `pip install open3d`

6.  (Optional) If you plan on developing/extending the code, install
    [nbdev](https://nbdev.fast.ai/)

7.  (Optional) Install the Blender plugin
    [MicroscopyNodes](https://github.com/oanegros/MicroscopyNodes) for
    rendering volumetric `.tif` files in blender

## Usage

To see how things work, it’s best to start with some fully-worked out
examples, which are provided in the `tutorials/` folder. Start by
[launching jupyter](https://docs.jupyter.org/en/latest/running.html) and
open `tutorials/02_basics_example.ipynb`. It is recommended you are
comfortable with running simple python code (you don’t have to do any
coding yourself), and know the basic user interface of blender (again,
nothing fancy).

In general, for each tissue cartography project, first create a folder
to hold your data and results. You run the `blender_tissue_cartography`
pipeline from a jupyter computational notebook, which can also serve as
your lab notebook (notes, comments on the data). Use one of the tutorial
jupyter notebooks as a template with instructions. As you work through
the notebook, you will:

1.  create a segmentation of your 3d data

2.  convert the segmentation into a mesh of your surface of interest

3.  load the mesh into blender to map to unwrap it into the plane

4.  make a cartographic projection of your the 3d data using the
    unwrapped mesh

5.  visualize the results in 3d using blender.

Here’s a screenshot to give you an idea of the work flow for the example
*Drosophila* dataset: Volumetric data in ImageJ (center), jupyter
computational notebook to run the `blender_tissue_cartography` module
(left), and blender project with extracted mesh and texture (right):

![image.png](index_files/figure-commonmark/cell-5-1-image.png)

## Software stack

### Required

- Python, with the following libraries
  - [jupyter](https://jupyter.org/)
  - [Numpy](https://numpy.org/) / [Matplotlib](https://matplotlib.org/)
    / [Scipy](https://scipy.org/)
  - [skimage](https://scikit-image.org) various image processing tools.
  - [h5py](https://www.h5py.org/) for reading/writing of `.h5` files.
  - [tifffile](https://github.com/cgohlke/tifffile/) for reading/writing
    of `.tif` files, including metadata.
  - [PyMCubes](https://github.com/pmneila/PyMCubes) Marching cubes.
- [Ilastik](https://www.ilastik.org/) Image classification and
  segmentation,
- [Blender](https://www.blender.org/) Mesh editing and UV mapping.

### Optional

- [Meshlab](https://www.meshlab.net/) GUI and python library with
  advanced surface reconstruction tools (required for some workflows).

- Python libraries:

  - [Open3d](https://www.open3d.org) 3d geometry library.
  - [PyMeshLab](https://pymeshlab.readthedocs.io/en/latest/index.html)
    Python interface to MeshLab.
  - [Morphsnakes](https://github.com/pmneila/morphsnakes) “Inflating
    balloon” segmentation
  - [nbdev](https://nbdev.fast.ai/tutorials/tutorial.html) for
    notebook-based development, if you want to add your own code
  - [trimesh](https://trimesh.org/) for working with triangular meshes

- Blender plugins:

  - [MicroscopyNodes](https://github.com/oanegros/MicroscopyNodes) for
    rendering volumetric `.tif` files in blender
